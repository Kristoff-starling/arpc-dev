# aRPC Message Format and Wire Format

In aRPC, the **message format** refers to the serialized layout of an RPC request or response as seen by the application, while the **wire format** defines how that message is fragmented and transmitted over the network.

---

## Message Structure

### Request Format

The request message is serialized as:

```
[service_len][service][method_len][method][payload]
```

Where:

* `service` (`[]byte`): UTF-8 encoded service name.
* `method` (`[]byte`): UTF-8 encoded method name.
* `payload` (`[]byte`): Encoded RPC request body (e.g., protobuf or flatbuffers).


## Wire Format

The wire format is used to transmit a possibly fragmented message over the network. It prepends a fixed-size framing header to each packet.

Each packet has the structure:

```
[packet_type][rpc_id][total_packets][seq_number][payload]
```

Where:

* `packet_type` (`uint8`): 1 = data, 2 = acknowledgement etc
* `rpc_id` (`uint64`): Unique ID assigned to each RPC.
* `total_packets` (`uint16`): Total number of packets in this message.
* `seq_number` (`uint16`): Sequence number of this packet.
* `payload` (`[]byte`): Fragment of the full serialized message.


# Example On-Wire Packet

This section demonstrates the full on-wire binary format of an aRPC request message, including both the **packet header** (used for fragmentation/reassembly) and the **message payload** (generated by the Symphony serializer).

---

## Request

```go
req := &echo.EchoRequest{
	Id:       42,
	Score:    100,
	Username: "alice",
	Content:  "Bob",
}
```

---

## On-Wire Hex Dump

```
01c5eece67c68b5318010000000b004563686f5365727669636504004563686f00010203040308000500040d0003002a00000064000000616c696365426f62
```

This is the serialized **UDP packet payload**. It consists of:

---

### Packet Header (13 bytes)

```
01 c5eece67c68b5318 0100 0000
└─┘ └─────────────┘ └──┘ └──┘
│   │                │    │
│   └─ RPC ID        │    └─ Sequence number (0)
│                    └─ Total packets (1)
└─ Packet type = 0x01 (request)
```

* **Packet Type**: `0x01` = Request
* **RPC ID**: `0x18538bc667ceeec5` (Little Endian)
* **Total Packets**: `1` (no fragmentation)
* **Sequence Number**: `0`

---

### Message Header (Layout + Service/Method Names)

```
0b 00                                → Length: 11 bytes
45 63 68 6f 53 65 72 76 69 63 65     → "EchoService"
04 00                                → Length: 4 bytes
45 63 68 6f                          → "Echo"
```

This is the serialized output of `frameRequest(service, method, payload)`:

```
[service_len][service][method_len][method]
```

---

### Message Payload

```
00                                  → layout_header
01 02 03 04                         → field order: Id, Score, Username, Content

03 08 00 05 00                      → Field 3 (Username): offset 8, len 5
04 0d 00 03 00                      → Field 4 (Content): offset 13, len 3

2a 00 00 00                         → Id = 42
64 00 00 00                         → Score = 100

61 6c 69 63 65                     → Username = "alice"
42 6f 62                           → Content  = "Bob"
```

---

### Fully Decoded

This packet encodes the following RPC call:

```go
EchoService.Echo(
	Id:       42,
	Score:    100,
	Username: "alice",
	Content:  "Bob",
)
```

